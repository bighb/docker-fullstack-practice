# Docker 端口冲突问题排查指南

## 问题背景

在 macOS 环境下开发 Docker 全栈项目时，访问 `http://localhost:5000/api/users` 返回 **403 Forbidden** 错误，但服务显示启动成功。

## 问题现象

| 表现 | 描述 |
|------|------|
| 容器状态 | `docker-compose ps` 显示所有服务正常运行 |
| 后端日志 | 无异常错误信息 |
| 接口响应 | 返回 403 Forbidden（而非 500 或 Connection Refused） |
| 前端表现 | API 请求失败，但错误信息不明确 |

## 问题根因

**macOS AirPlay Receiver 占用了端口 5000**

从 macOS Monterey (12.0) 开始，系统的 **AirPlay 接收器** 功能默认监听 5000 和 7000 端口。当 Docker 尝试将容器端口映射到宿主机 5000 端口时：

1. Docker 端口映射可能静默失败或被系统服务抢占
2. 请求被 macOS 的 AirPlay 服务接收
3. AirPlay 服务返回 403 Forbidden（因为它不识别 HTTP API 请求）

## 为什么前端/浏览器难以发现

1. **错误信息模糊**：浏览器只显示 403 状态码，无法区分是应用返回还是系统服务返回
2. **CORS 掩盖真相**：跨域请求失败时，浏览器出于安全考虑隐藏详细错误
3. **容器状态误导**：`docker-compose ps` 显示容器运行中，给人一切正常的错觉
4. **没有连接失败**：不像端口未开放会返回 Connection Refused，403 暗示"服务存在但拒绝请求"

## 解决流程

### 第一步：确认端口占用情况

```bash
# 检查 5000 端口被谁占用
lsof -i :5000

# 典型输出（如果是 AirPlay 占用）：
# COMMAND     PID   USER   FD   TYPE             DEVICE SIZE/OFF NODE NAME
# ControlCe  1234  user   xx   IPv4/IPv6  0x...      0t0  TCP *:5000 (LISTEN)
```

如果看到 `ControlCe` 或 `AirPlayXPCHelper`，确认是 AirPlay 服务占用。

### 第二步：选择解决方案

**方案 A：关闭 AirPlay Receiver（推荐，如果不使用 AirPlay）**

```
系统设置 → 通用 → 隔空投送与接力 → 关闭「AirPlay 接收器」
```

**方案 B：更换应用端口（本项目采用的方案）**

修改以下文件，将 5000 改为 5001：

| 文件 | 修改项 |
|------|--------|
| `.env` | `PORT=5001`<br>`REACT_APP_API_URL=http://localhost:5001` |
| `docker-compose.yml` | `ports: "5001:5001"` |
| `nginx/nginx.conf` | `server backend:5001` |
| `backend/Dockerfile` | `EXPOSE 5001`<br>HEALTHCHECK URL |

### 第三步：重启服务并验证

```bash
# 重启所有服务
docker-compose down && docker-compose up -d

# 等待服务就绪后验证
curl http://localhost:5001/api/health
curl http://localhost:5001/api/users
```

## 推荐排查流程

遇到 Docker 服务"启动成功但无法访问"时，按以下顺序排查：

### 1. 检查容器真实状态

```bash
# 查看容器状态
docker-compose ps

# 查看容器日志（重点关注启动错误）
docker-compose logs backend --tail=50

# 进入容器内部测试
docker-compose exec backend sh
curl http://localhost:5001/api/health  # 容器内访问
```

### 2. 检查端口映射

```bash
# 查看 Docker 端口映射
docker port fullstack_backend

# 检查宿主机端口占用
lsof -i :5000
lsof -i :5001

# 或使用 netstat
netstat -an | grep -E '500[01]'
```

### 3. 分层测试网络连通性

```bash
# 层级 1：容器内部（应用是否正常）
docker-compose exec backend curl http://localhost:5001/api/health

# 层级 2：Docker 网络（容器间通信）
docker-compose exec nginx curl http://backend:5001/api/health

# 层级 3：宿主机（端口映射是否生效）
curl http://localhost:5001/api/health

# 层级 4：浏览器（是否有 CORS 等问题）
# 打开浏览器开发者工具 Network 面板查看
```

### 4. 常见错误码对照表

| 错误 | 可能原因 | 排查方向 |
|------|---------|---------|
| **Connection Refused** | 服务未启动/端口未监听 | 检查容器日志和应用启动 |
| **403 Forbidden** | 权限问题/端口被其他服务占用 | 检查端口占用、Nginx 配置 |
| **404 Not Found** | 路由不存在 | 检查 API 路径是否正确 |
| **500 Internal Error** | 应用内部错误 | 检查后端日志、数据库连接 |
| **502 Bad Gateway** | 上游服务不可用 | 检查 Nginx upstream 配置 |
| **CORS Error** | 跨域配置问题 | 检查后端 CORS 中间件 |

## macOS 常见端口冲突

| 端口 | 占用服务 | 说明 |
|------|---------|------|
| 5000 | AirPlay Receiver | macOS 12+ 默认开启 |
| 7000 | AirPlay Receiver | macOS 12+ 默认开启 |
| 5432 | PostgreSQL | 如本地安装了 PostgreSQL |
| 3306 | MySQL | 如本地安装了 MySQL |
| 6379 | Redis | 如本地安装了 Redis |
| 80/443 | 各种 Web 服务 | Apache/Nginx 等 |

## 预防措施

1. **避开常用端口**：使用 5001、8080、3001 等不易冲突的端口
2. **启动前检查**：养成 `lsof -i :<port>` 检查端口的习惯
3. **使用端口范围**：在 `.env` 中集中管理端口，便于统一修改
4. **添加启动脚本**：编写脚本在启动前自动检测端口冲突

```bash
#!/bin/bash
# check-ports.sh
PORTS=(5001 3000 5432 6379)
for port in "${PORTS[@]}"; do
  if lsof -i :$port > /dev/null 2>&1; then
    echo "Warning: Port $port is already in use!"
    lsof -i :$port
  fi
done
```

## 参考链接

- [Apple: 如果无法在 Mac 上使用 AirPlay](https://support.apple.com/zh-cn/HT204289)
- [Docker: 网络配置](https://docs.docker.com/network/)
- [Docker Compose: ports 配置](https://docs.docker.com/compose/compose-file/#ports)
