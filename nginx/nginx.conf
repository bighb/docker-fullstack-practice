# events 块:配置影响 nginx 服务器或与用户的网络连接
events {
    # 设置单个工作进程的最大并发连接数为 1024
    worker_connections 1024;
}

# http 块:配置代理、缓存、日志定义等绝大多数功能
http {
    # 定义后端服务的上游服务器组
    upstream backend {
        # 指定后端服务的地址和端口(Docker 容器名:端口)
        server backend:5001;
    }

    # 定义前端服务的上游服务器组
    upstream frontend {
        # 指定前端服务的地址和端口(Docker 容器名:端口)
        server frontend:3000;
    }

    # server 块:配置虚拟主机的相关参数
    server {
        # 监听 80 端口
        listen 80;
        # 设置服务器域名
        server_name localhost;

        # 前端路由配置:处理所有根路径请求
        location / {
            # 将请求代理到前端服务
            proxy_pass http://frontend;
            # 使用 HTTP 1.1 协议
            proxy_http_version 1.1;
            # 转发 WebSocket 升级请求头
            proxy_set_header Upgrade $http_upgrade;
            # 转发 WebSocket 连接请求头
            proxy_set_header Connection 'upgrade';
            # 转发原始 Host 请求头
            proxy_set_header Host $host;
            # 不缓存需要升级的请求(如 WebSocket)
            proxy_cache_bypass $http_upgrade;
        }

        # 后端 API 路由配置:处理所有 /api 开头的请求
        location /api {
            # 将请求代理到后端服务
            proxy_pass http://backend;
            # 使用 HTTP 1.1 协议
            proxy_http_version 1.1;
            # 转发原始 Host 请求头
            proxy_set_header Host $host;
            # 转发客户端真实 IP 地址
            proxy_set_header X-Real-IP $remote_addr;
            # 转发代理链路中的所有 IP 地址
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            # 转发原始请求协议(http 或 https)
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
