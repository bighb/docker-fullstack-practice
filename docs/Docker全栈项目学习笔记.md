# Docker 全栈项目学习笔记

## 目录

1. [常见问题：npm ci 报错](#1-常见问题npm-ci-报错)
2. [Docker Compose 运作流程](#2-docker-compose-运作流程)
3. [多阶段构建与运行模式](#3-多阶段构建与运行模式)
4. [环境变量注入方式](#4-环境变量注入方式)
5. [配置文件最佳实践](#5-配置文件最佳实践)

---

## 1. 常见问题：npm ci 报错

### 问题现象

运行 `docker-compose up` 时出现以下错误：

```
npm error The `npm ci` command can only install with an existing package-lock.json or
npm error npm-shrinkwrap.json with lockfileVersion >= 1.
```

### 根本原因

Dockerfile 中使用了 `npm ci` 命令，但项目目录下**缺少 `package-lock.json` 文件**。

### `npm ci` vs `npm install` 对比

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        npm install vs npm ci                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  npm install                          npm ci                                │
│  ┌──────────────────────┐             ┌──────────────────────┐              │
│  │ 输入: package.json   │             │ 输入: package.json   │              │
│  │                      │             │     + package-lock   │ ← 必须有！   │
│  └──────────┬───────────┘             └──────────┬───────────┘              │
│             │                                    │                          │
│             ▼                                    ▼                          │
│  ┌──────────────────────┐             ┌──────────────────────┐              │
│  │ 解析依赖版本范围     │             │ 严格按 lock 文件安装 │              │
│  │ (如 ^1.0.0 → 1.2.3) │             │ (版本完全一致)       │              │
│  └──────────┬───────────┘             └──────────┬───────────┘              │
│             │                                    │                          │
│             ▼                                    ▼                          │
│  ┌──────────────────────┐             ┌──────────────────────┐              │
│  │ 生成/更新 lock 文件  │             │ 不修改任何文件       │              │
│  └──────────────────────┘             └──────────────────────┘              │
│                                                                             │
│  适用场景: 开发环境                   适用场景: CI/CD、生产环境             │
│  特点: 灵活，可能每次版本不同         特点: 可重现的构建                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 解决方案

```bash
# 在项目目录下生成 package-lock.json
cd backend && npm install

# 然后重新构建
docker-compose up -d --build
```

### 最佳实践

- `package-lock.json` **必须提交到 Git**，确保团队环境一致
- 生产环境 Dockerfile 使用 `npm ci`，保证可重现构建
- 开发环境可以使用 `npm install`

---

## 2. Docker Compose 运作流程

### `docker-compose up -d` 完整流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         docker-compose up -d                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  阶段 1: 解析配置                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ • 读取 docker-compose.yml                                           │    │
│  │ • 读取 .env 文件（如果存在）                                         │    │
│  │ • 替换 ${变量} 为实际值                                              │    │
│  │ • 解析服务定义、网络、卷配置                                         │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  阶段 2: 镜像准备                                                            │
│                                                                             │
│     对于每个服务，检查镜像来源：                                              │
│                                                                             │
│     ┌────────────────────────────────────────────────────────────────┐      │
│     │              服务定义方式                                       │      │
│     └────────────────────┬───────────────────────────────────────────┘      │
│                          │                                                  │
│            ┌─────────────┴─────────────┐                                    │
│            ▼                           ▼                                    │
│     ┌─────────────────┐         ┌─────────────────┐                         │
│     │ 有 build: 配置  │         │ 只有 image: 配置│                         │
│     │ (如 backend)    │         │ (如 postgres)   │                         │
│     └────────┬────────┘         └────────┬────────┘                         │
│              │                           │                                  │
│              ▼                           ▼                                  │
│     ┌─────────────────┐         ┌─────────────────┐                         │
│     │ 本地镜像存在?   │         │ 从 Docker Hub   │                         │
│     └────────┬────────┘         │ 拉取镜像        │                         │
│              │                  └─────────────────┘                         │
│       ┌──────┴──────┐                                                       │
│       ▼             ▼                                                       │
│     存在          不存在                                                     │
│       │             │                                                       │
│       │             ▼                                                       │
│       │    ┌─────────────────┐                                              │
│       │    │ 自动执行 build  │  ← 这就是为什么不需要先 make build           │
│       │    │ 构建镜像        │                                              │
│       │    └─────────────────┘                                              │
│       │             │                                                       │
│       └──────┬──────┘                                                       │
│              ▼                                                              │
│         镜像就绪                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  阶段 3: 创建基础设施                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ • 创建 Network（如 app-network）                                    │    │
│  │ • 创建 Volume（如 postgres_data, redis_data）                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  阶段 4: 按依赖顺序启动容器                                                   │
│                                                                             │
│     depends_on + condition 决定启动顺序：                                    │
│                                                                             │
│     ┌─────────────┐  ┌─────────────┐                                        │
│     │  postgres   │  │    redis    │     ← 第一批（无依赖）                  │
│     │  启动中...  │  │  启动中...  │                                        │
│     └──────┬──────┘  └──────┬──────┘                                        │
│            │                │                                               │
│            ▼                ▼                                               │
│     ┌─────────────┐  ┌─────────────┐                                        │
│     │  健康检查   │  │  健康检查   │     ← 等待 healthy                      │
│     │  pg_isready │  │ redis-cli   │                                        │
│     └──────┬──────┘  └──────┬──────┘                                        │
│            │                │                                               │
│            └───────┬────────┘                                               │
│                    ▼                                                        │
│            ┌─────────────┐                                                  │
│            │   backend   │               ← 第二批（依赖 postgres, redis）    │
│            └──────┬──────┘                                                  │
│                   │                                                         │
│                   ▼                                                         │
│            ┌─────────────┐                                                  │
│            │  frontend   │               ← 第三批（依赖 backend）            │
│            └──────┬──────┘                                                  │
│                   │                                                         │
│                   ▼                                                         │
│            ┌─────────────┐                                                  │
│            │    nginx    │               ← 第四批（依赖 frontend, backend）  │
│            └─────────────┘                                                  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                              ✅ 启动完成
```

### `build` vs `up` vs `up --build` 对比

| 命令 | 构建镜像 | 启动容器 | 使用场景 |
|------|:--------:|:--------:|----------|
| `docker-compose build` | ✅ | ❌ | 只构建，不启动 |
| `docker-compose up` | ⚠️ 仅当镜像不存在时 | ✅ | 日常启动 |
| `docker-compose up --build` | ✅ 强制重建 | ✅ | 代码修改后 |

### 关键点

```
⚠️ 重要：镜像一旦存在，docker-compose up 不会自动重建！

代码修改后的正确操作流程：
┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐
│  修改源代码       │ ──▶ │ docker-compose   │ ──▶ │  新代码生效      │
│  (backend/src)   │     │ up -d --build    │     │                  │
└──────────────────┘     └──────────────────┘     └──────────────────┘
```

---

## 3. 多阶段构建与运行模式

### Dockerfile 多阶段构建结构

```dockerfile
# backend/Dockerfile 结构示意

# ┌─────────────────────────────────────────────────────────────────────┐
# │ Stage 1: base - 基础层                                              │
# ├─────────────────────────────────────────────────────────────────────┤
FROM node:18-alpine AS base
WORKDIR /app
COPY package*.json ./
# └─────────────────────────────────────────────────────────────────────┘

# ┌─────────────────────────────────────────────────────────────────────┐
# │ Stage 2: development - 开发环境                                     │
# ├─────────────────────────────────────────────────────────────────────┤
FROM base AS development
RUN npm install          # 安装所有依赖（包括 devDependencies）
COPY . .
CMD ["npm", "run", "dev"] # 开发服务器，支持热重载
# └─────────────────────────────────────────────────────────────────────┘

# ┌─────────────────────────────────────────────────────────────────────┐
# │ Stage 3: builder - 构建阶段（中间层，不会出现在最终镜像）            │
# ├─────────────────────────────────────────────────────────────────────┤
FROM base AS builder
RUN npm ci --only=production  # 只安装生产依赖
COPY . .
# └─────────────────────────────────────────────────────────────────────┘

# ┌─────────────────────────────────────────────────────────────────────┐
# │ Stage 4: production - 生产环境（精简镜像）                          │
# ├─────────────────────────────────────────────────────────────────────┤
FROM node:18-alpine AS production
WORKDIR /app
RUN adduser -S nodejs        # 创建非 root 用户
COPY --from=builder /app/node_modules ./node_modules
COPY . .
USER nodejs                  # 使用非 root 用户运行
CMD ["node", "src/index.js"] # 直接运行，无需 nodemon
# └─────────────────────────────────────────────────────────────────────┘
```

### 多阶段构建与 docker-compose 的关系

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Dockerfile 阶段选择机制                                   │
└─────────────────────────────────────────────────────────────────────────────┘

                         Dockerfile
                    ┌─────────────────┐
                    │     base        │
                    └────────┬────────┘
                             │
              ┌──────────────┼──────────────┐
              ▼              ▼              ▼
       ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
       │ development │ │   builder   │ │ production  │
       └──────┬──────┘ └──────┬──────┘ └──────┬──────┘
              │               │               │
              │               └───────────────┤
              │                               │
              ▼                               ▼
┌─────────────────────────────┐   ┌─────────────────────────────┐
│   docker-compose.yml        │   │   docker-compose.prod.yml   │
│                             │   │                             │
│   build:                    │   │   build:                    │
│     target: development ────┼───│     target: production ─────│
│                             │   │                             │
│   volumes:                  │   │   volumes: []               │
│     - ./src:/app/src  ──────┼───│   (清空，不挂载源码)         │
│   (挂载源码，热重载)         │   │                             │
│                             │   │   restart: always           │
│   command: npm run dev      │   │   (自动重启)                 │
│   (开发服务器)               │   │                             │
└─────────────────────────────┘   └─────────────────────────────┘
              │                               │
              ▼                               ▼
       ┌─────────────┐                 ┌─────────────┐
       │  开发模式    │                 │  生产模式    │
       │  镜像较大    │                 │  镜像精简    │
       │  含调试工具  │                 │  安全加固    │
       └─────────────┘                 └─────────────┘
```

### 开发模式 vs 生产模式对比

| 特性 | 开发模式 | 生产模式 |
|------|----------|----------|
| **Dockerfile 阶段** | `target: development` | `target: production` |
| **依赖安装** | `npm install`（全部） | `npm ci --only=production` |
| **源码挂载** | `./src:/app/src`（热重载） | 无挂载（代码打包在镜像内） |
| **启动命令** | `npm run dev`（nodemon） | `node src/index.js` |
| **运行用户** | root | nodejs（非 root） |
| **重启策略** | 无 | `restart: always` |
| **镜像大小** | 较大（含 devDependencies） | 精简 |

### 配置文件对比

**docker-compose.yml（开发模式）:**
```yaml
backend:
  build:
    context: ./backend
    target: development        # ← 使用开发阶段
  volumes:
    - ./backend/src:/app/src   # ← 源码挂载，支持热重载
  command: npm run dev         # ← 开发服务器
```

**docker-compose.prod.yml（生产模式覆盖）:**
```yaml
backend:
  build:
    target: production         # ← 覆盖为生产阶段
  volumes: []                  # ← 清空源码挂载
  command: []                  # ← 使用 Dockerfile 默认 CMD
  restart: always              # ← 添加自动重启
```

### 启动命令

```bash
# 开发模式
docker-compose up -d
# 或
make up

# 生产模式（合并两个配置文件）
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# 或
make prod-up
```

---

## 4. 环境变量注入方式

### 三种注入方式对比

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        环境变量注入方式对比                                   │
└─────────────────────────────────────────────────────────────────────────────┘

方式 1: 硬编码（不推荐）
━━━━━━━━━━━━━━━━━━━━━━━━
┌─────────────────────────────────────┐
│ docker-compose.yml                  │
│                                     │
│ environment:                        │
│   DB_PASSWORD: postgres123  ← 写死  │
│   DB_USER: postgres                 │
└─────────────────────────────────────┘
问题：敏感信息暴露在配置文件中，不安全


方式 2: 变量引用 + .env 文件（推荐）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
┌─────────────────┐         ┌─────────────────────────────────┐
│ .env            │         │ docker-compose.yml              │
│                 │         │                                 │
│ DB_USER=postgres│────────▶│ environment:                    │
│ DB_PASSWORD=xxx │         │   DB_USER: ${DB_USER}           │
└─────────────────┘         │   DB_PASSWORD: ${DB_PASSWORD}   │
                            └─────────────────────────────────┘
优点：
• Docker Compose 自动读取同目录下的 .env 文件
• 敏感信息与配置分离
• .env 可加入 .gitignore 不提交


方式 3: env_file 指令
━━━━━━━━━━━━━━━━━━━━━━
┌─────────────────┐         ┌─────────────────────────────────┐
│ .env            │         │ docker-compose.yml              │
│                 │         │                                 │
│ DB_USER=postgres│────────▶│ services:                       │
│ DB_PASSWORD=xxx │         │   backend:                      │
│ NODE_ENV=dev    │         │     env_file:                   │
└─────────────────┘         │       - .env                    │
                            └─────────────────────────────────┘
特点：将整个文件的所有变量直接注入容器环境
```

### 变量引用方式详解

```yaml
# docker-compose.yml

services:
  postgres:
    environment:
      # ${变量名} 语法 - 从 .env 文件或系统环境变量读取
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}

  backend:
    environment:
      NODE_ENV: ${NODE_ENV}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
```

```bash
# .env 文件

DB_HOST=postgres
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=postgres123
DB_NAME=myapp
NODE_ENV=development
```

### 变量替换流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Docker Compose 变量替换流程                               │
└─────────────────────────────────────────────────────────────────────────────┘

    docker-compose up
           │
           ▼
┌─────────────────────┐
│ 1. 读取 .env 文件   │
│    (同目录下自动)   │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 2. 解析 yml 文件    │
│    找到 ${变量}     │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐     ┌─────────────────────┐
│ 3. 变量替换         │     │ .env 内容:          │
│                     │     │ DB_PASSWORD=xxx     │
│ ${DB_PASSWORD}  ────┼────▶│                     │
│       ↓             │     └─────────────────────┘
│      xxx            │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 4. 注入到容器       │
│    环境变量         │
└─────────────────────┘
```

### 验证环境变量注入

```bash
# 查看容器内的环境变量
docker-compose exec backend env | grep DB_

# 输出示例:
# DB_HOST=postgres
# DB_PORT=5432
# DB_USER=postgres
# DB_PASSWORD=postgres123
# DB_NAME=myapp
```

---

## 5. 配置文件最佳实践

### 推荐的项目结构

```
project/
├── docker-compose.yml          # 基础配置 / 开发环境
├── docker-compose.prod.yml     # 生产环境覆盖配置
├── docker-compose.override.yml # (可选) 本地开发个人配置
│
├── .env.example                # 环境变量模板（提交到 Git）
├── .env                        # 实际环境变量（不提交）
├── .env.production             # (可选) 生产环境变量
│
├── .gitignore                  # 忽略 .env 等敏感文件
├── Makefile                    # 常用命令快捷方式
│
├── backend/
│   ├── Dockerfile              # 多阶段构建
│   ├── package.json
│   ├── package-lock.json       # 必须提交！
│   └── src/
│
└── frontend/
    ├── Dockerfile
    ├── package.json
    ├── package-lock.json
    └── src/
```

### .gitignore 配置

```gitignore
# 环境变量（包含敏感信息）
.env
.env.local
.env.production

# 依赖目录
node_modules/

# 日志和备份
*.log
*.sql
!database/init.sql
```

### Makefile 命令速查

```makefile
# 开发环境
make up          # 启动开发环境
make down        # 停止服务
make logs        # 查看日志
make restart     # 重启服务

# 生产环境
make prod-build  # 构建生产镜像
make prod-up     # 启动生产环境

# 调试
make exec-backend  # 进入后端容器
make exec-db       # 进入数据库

# 清理
make clean       # 停止并删除容器和卷
make prune       # 清理 Docker 系统
```

### 安全检查清单

- [ ] `.env` 文件已加入 `.gitignore`
- [ ] 生产环境使用强密码
- [ ] 敏感端口不对外暴露（如数据库 5432）
- [ ] 生产镜像使用非 root 用户运行
- [ ] `package-lock.json` 已提交到 Git

---

## 总结

### 核心概念关系图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Docker 全栈项目核心概念                               │
└─────────────────────────────────────────────────────────────────────────────┘

                              .env
                          (环境变量)
                               │
                               ▼
    ┌──────────────────────────────────────────────────────┐
    │              docker-compose.yml                      │
    │                                                      │
    │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐ │
    │  │postgres │  │  redis  │  │ backend │  │frontend │ │
    │  │ (image) │  │ (image) │  │ (build) │  │ (build) │ │
    │  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘ │
    │       │            │            │            │      │
    └───────┼────────────┼────────────┼────────────┼──────┘
            │            │            │            │
            │            │            ▼            ▼
            │            │      ┌─────────────────────┐
            │            │      │    Dockerfile       │
            │            │      │  (多阶段构建)        │
            │            │      │                     │
            │            │      │  • development      │
            │            │      │  • production       │
            │            │      └─────────────────────┘
            │            │            │
            ▼            ▼            ▼
    ┌─────────────────────────────────────────────────────┐
    │                   Docker Engine                     │
    │                                                     │
    │  Networks ──── Volumes ──── Containers              │
    │                                                     │
    └─────────────────────────────────────────────────────┘
```

### 常用命令速查表

| 场景 | 命令 |
|------|------|
| 首次启动 | `cp .env.example .env && docker-compose up -d` |
| 日常启动 | `docker-compose up -d` |
| 代码修改后 | `docker-compose up -d --build` |
| 生产部署 | `docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d` |
| 查看日志 | `docker-compose logs -f [service]` |
| 进入容器 | `docker-compose exec [service] sh` |
| 完全清理 | `docker-compose down -v` |
