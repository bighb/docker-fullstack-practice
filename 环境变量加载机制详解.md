# ç¯å¢ƒå˜é‡åŠ è½½æœºåˆ¶è¯¦è§£

## é—®é¢˜èƒŒæ™¯

åœ¨ `frontend/src/App.js` ä¸­æœ‰è¿™æ ·çš„ä»£ç ï¼š

```javascript
const API_URL = process.env.REACT_APP_API_URL || "http://localhost:5001";
```

ä¸ºä»€ä¹ˆå®ƒèƒ½è¯»å–åˆ°é¡¹ç›®æ ¹ç›®å½•çš„ `.env` æ–‡ä»¶ï¼ŸåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

---

## æ ¸å¿ƒç»“è®º

**å‰ç«¯å’Œåç«¯è¯»å–ç¯å¢ƒå˜é‡çš„æ–¹å¼å®Œå…¨ä¸åŒï¼**

- **åç«¯**: Docker Compose é€šè¿‡ `environment` å­—æ®µç›´æ¥æ³¨å…¥
- **å‰ç«¯**: Create React App å†…ç½® dotenv + Docker Compose æ³¨å…¥

---

## ä¸€ã€é¡¹ç›®ç»“æ„åˆ†æ

### 1.1 Monorepo ç»“æ„è¯†åˆ«

```
docker-fullstack-practice/          â† é¡¹ç›®æ ¹ç›®å½•
â”œâ”€â”€ .env                            â† å…±äº«ç¯å¢ƒå˜é‡é…ç½®
â”œâ”€â”€ docker-compose.yml              â† ç»Ÿä¸€ç¼–æ’æ‰€æœ‰æœåŠ¡
â”œâ”€â”€ frontend/                       â† å‰ç«¯å­é¡¹ç›®
â”‚   â”œâ”€â”€ package.json               â† ç‹¬ç«‹çš„ä¾èµ–ç®¡ç†
â”‚   â””â”€â”€ src/App.js
â”œâ”€â”€ backend/                        â† åç«¯å­é¡¹ç›®
â”‚   â”œâ”€â”€ package.json               â† ç‹¬ç«‹çš„ä¾èµ–ç®¡ç†
â”‚   â””â”€â”€ src/index.js
â”œâ”€â”€ database/
â””â”€â”€ nginx/
```

**Monorepo ç‰¹å¾ï¼š**
- âœ… å¤šä¸ªç‹¬ç«‹å­é¡¹ç›®åœ¨åŒä¸€ä¸ªä»£ç ä»“åº“
- âœ… å…±äº«é…ç½®æ–‡ä»¶ï¼ˆ`.env`ã€`docker-compose.yml`ï¼‰
- âœ… ç»Ÿä¸€çš„éƒ¨ç½²å’Œç¼–æ’

---

## äºŒã€ç¯å¢ƒå˜é‡åŠ è½½æœºåˆ¶

### 2.1 åç«¯ï¼ˆNode.jsï¼‰åŠ è½½æœºåˆ¶

#### âŒ å¸¸è§è¯¯è§£

å¾ˆå¤šäººä»¥ä¸º dotenv ä¼šè‡ªåŠ¨å‘ä¸ŠæŸ¥æ‰¾ `.env` æ–‡ä»¶ï¼Œ**è¿™æ˜¯é”™è¯¯çš„ï¼**

```javascript
// dotenv ä¸ä¼šè‡ªåŠ¨å‘ä¸ŠæŸ¥æ‰¾
require('dotenv').config();  // åªè¯»å–å½“å‰ç›®å½•çš„ .env
```

#### âœ… å®é™…æœºåˆ¶ï¼šDocker Compose æ³¨å…¥

**æŸ¥çœ‹ `docker-compose.yml` é…ç½®ï¼š**

```yaml
services:
  backend:
    environment:
      NODE_ENV: ${NODE_ENV}           # ä»æ ¹ç›®å½• .env è¯»å–
      PORT: ${PORT}
      DB_HOST: ${DB_HOST}
      DB_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: ${REDIS_HOST}
      # ... æ›´å¤šå˜é‡
```

**å·¥ä½œæµç¨‹ï¼š**

```
1. Docker Compose å¯åŠ¨
   â†“
2. è¯»å–æ ¹ç›®å½• .env æ–‡ä»¶
   â†“
3. é€šè¿‡ environment å­—æ®µæ³¨å…¥åˆ° backend å®¹å™¨
   â†“
4. Node.js è¿›ç¨‹ç›´æ¥ä» process.env è·å–
   â†“
5. æ— éœ€ require('dotenv').config()
```

**ä»£ç ç¤ºä¾‹ï¼ˆbackend/src/index.jsï¼‰ï¼š**

```javascript
// âŒ æ²¡æœ‰è¿™ä¸€è¡Œï¼ˆå› ä¸ºä¸éœ€è¦ï¼‰
// require('dotenv').config();

// âœ… ç›´æ¥ä½¿ç”¨ï¼Œå˜é‡å·²ç”± Docker Compose æ³¨å…¥
const pool = new Pool({
  host: process.env.DB_HOST,        // Docker æ³¨å…¥çš„ç¯å¢ƒå˜é‡
  port: process.env.DB_PORT,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
});
```

---

### 2.2 å‰ç«¯ï¼ˆReactï¼‰åŠ è½½æœºåˆ¶

#### âœ… Create React App å†…ç½®æœºåˆ¶

**æŸ¥çœ‹ `docker-compose.yml` é…ç½®ï¼š**

```yaml
services:
  frontend:
    environment:
      - REACT_APP_API_URL=${REACT_APP_API_URL}  # ä»æ ¹ç›®å½• .env è¯»å–å¹¶æ³¨å…¥
```

**å·¥ä½œæµç¨‹ï¼š**

```
1. Docker Compose å¯åŠ¨
   â†“
2. è¯»å–æ ¹ç›®å½• .env æ–‡ä»¶ä¸­çš„ REACT_APP_API_URL
   â†“
3. æ³¨å…¥åˆ° frontend å®¹å™¨ç¯å¢ƒå˜é‡
   â†“
4. npm start (react-scripts) å¯åŠ¨
   â†“
5. react-scripts è‡ªåŠ¨è¯»å–ä»¥ REACT_APP_ å¼€å¤´çš„ç¯å¢ƒå˜é‡
   â†“
6. Webpack æ„å»ºæ—¶ï¼Œé€šè¿‡ DefinePlugin æ›¿æ¢ä»£ç ä¸­çš„ process.env.REACT_APP_XXX
   â†“
7. æœ€ç»ˆæ‰“åŒ…çš„ JS æ–‡ä»¶ä¸­ï¼Œå˜é‡å·²è¢«æ›¿æ¢æˆå®é™…å€¼
```

**ä»£ç ç¤ºä¾‹ï¼ˆfrontend/src/App.jsï¼‰ï¼š**

```javascript
// æ„å»ºå‰çš„æºä»£ç 
const API_URL = process.env.REACT_APP_API_URL || "http://localhost:5001";

// æ„å»ºåçš„ç”Ÿäº§ä»£ç ï¼ˆå˜é‡å·²è¢«æ›¿æ¢ï¼‰
const API_URL = "http://localhost:5001" || "http://localhost:5001";
```

**é‡è¦å®‰å…¨æœºåˆ¶ï¼š**
- âœ… åªæœ‰ `REACT_APP_` å¼€å¤´çš„å˜é‡æ‰ä¼šè¢«æ³¨å…¥
- âŒ å…¶ä»–ç¯å¢ƒå˜é‡ï¼ˆå¦‚ DB_PASSWORDï¼‰ä¸ä¼šæš´éœ²åˆ°å‰ç«¯
- ğŸ”’ é˜²æ­¢æ•æ„Ÿä¿¡æ¯æ³„éœ²åˆ°æµè§ˆå™¨

---

## ä¸‰ã€dotenv çš„æ­£ç¡®ç”¨æ³•

### 3.1 æ ‡å‡†ç”¨æ³•

```javascript
// è¯»å–å½“å‰ç›®å½•çš„ .env æ–‡ä»¶
require('dotenv').config();

// è¯»å–æŒ‡å®šè·¯å¾„çš„ .env æ–‡ä»¶
require('dotenv').config({ path: '../.env' });
require('dotenv').config({ path: '/absolute/path/to/.env' });
```

### 3.2 dotenv æŸ¥æ‰¾è§„åˆ™

**âŒ é”™è¯¯è§‚å¿µï¼š**
"dotenv ä¼šè‡ªåŠ¨å‘ä¸ŠæŸ¥æ‰¾çˆ¶ç›®å½•çš„ .env æ–‡ä»¶"

**âœ… çœŸå®æƒ…å†µï¼š**
- dotenv åªè¯»å–**æ˜ç¡®æŒ‡å®šçš„è·¯å¾„**
- é»˜è®¤è·¯å¾„æ˜¯**å½“å‰å·¥ä½œç›®å½•**ï¼ˆ`process.cwd()`ï¼‰
- ä¸ä¼šè‡ªåŠ¨å‘ä¸Šçº§ç›®å½•æŸ¥æ‰¾

### 3.3 æœ¬åœ°å¼€å‘é…ç½®ï¼ˆä¸ç”¨ Dockerï¼‰

å¦‚æœç›´æ¥è¿è¡Œ `node backend/src/index.js`ï¼Œéœ€è¦è¿™æ ·é…ç½®ï¼š

```javascript
// backend/src/index.js ç¬¬ä¸€è¡Œæ·»åŠ 
require('dotenv').config({ path: '../../.env' });  // æŒ‡å‘æ ¹ç›®å½• .env

const express = require("express");
// ... å…¶ä»–ä»£ç 
```

---

## å››ã€ä¸ºä»€ä¹ˆ .env æ”¾åœ¨æ ¹ç›®å½•ï¼Ÿ

### 4.1 ç»Ÿä¸€ç®¡ç†ä¼˜åŠ¿

```env
# .env æ–‡ä»¶åŒ…å«æ‰€æœ‰æœåŠ¡çš„é…ç½®

# æ•°æ®åº“é…ç½®ï¼ˆbackend ä½¿ç”¨ï¼‰
DB_HOST=postgres
DB_PASSWORD=postgres123

# Redis é…ç½®ï¼ˆbackend ä½¿ç”¨ï¼‰
REDIS_HOST=redis
REDIS_PORT=6379

# å‰ç«¯é…ç½®ï¼ˆfrontend ä½¿ç”¨ï¼‰
REACT_APP_API_URL=http://localhost:5001
```

### 4.2 Docker Compose ä¼˜åŠ¿

```yaml
# docker-compose.yml å¯ä»¥ç»Ÿä¸€è¯»å– .env
services:
  postgres:
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD}  # å¤ç”¨åŒä¸€ä¸ªå˜é‡
  
  backend:
    environment:
      DB_PASSWORD: ${DB_PASSWORD}        # å¤ç”¨åŒä¸€ä¸ªå˜é‡
```

### 4.3 å¯é€‰æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|
| **æ ¹ç›®å½• .env**ï¼ˆå½“å‰ï¼‰ | ç»Ÿä¸€ç®¡ç†ï¼ŒDocker Compose å‹å¥½ | å­é¡¹ç›®ä¸èƒ½ç‹¬ç«‹è¿è¡Œ |
| **å­ç›®å½•å„è‡ª .env** | å­é¡¹ç›®å¯ç‹¬ç«‹è¿è¡Œ | é…ç½®é‡å¤ï¼Œç»´æŠ¤éº»çƒ¦ |
| **ä¸¤è€…éƒ½æœ‰** | çµæ´»æ€§æœ€é«˜ | é…ç½®å†²çªé£é™© |

---

## äº”ã€å®Œæ•´å·¥ä½œæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     docker-compose up                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  è¯»å–æ ¹ç›®å½• .env æ–‡ä»¶  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚               â”‚               â”‚
         â–¼               â–¼               â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Postgresâ”‚     â”‚ Backend â”‚    â”‚ Frontend â”‚
   â”‚ Containerâ”‚    â”‚ Containerâ”‚   â”‚ Containerâ”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚               â”‚              â”‚
        â”‚ environment   â”‚ environment  â”‚ environment
        â”‚ æ³¨å…¥å˜é‡       â”‚ æ³¨å…¥å˜é‡      â”‚ æ³¨å…¥å˜é‡
        â”‚               â”‚              â”‚
        â–¼               â–¼              â–¼
  DB_PASSWORD      DB_HOST       REACT_APP_API_URL
  DB_USER          DB_PASSWORD   
  DB_NAME          REDIS_HOST    
                   PORT           
                        â”‚              â”‚
                        â–¼              â–¼
                 process.env    react-scripts
                      â”‚              â”‚
                      â–¼              â–¼
                 Node.js åº”ç”¨    Webpack æ„å»º
                                      â”‚
                                      â–¼
                               æ›¿æ¢æˆå®é™…å€¼
```

---

## å…­ã€å¸¸è§é—®é¢˜ FAQ

### Q1: ä¸ºä»€ä¹ˆåç«¯ä»£ç æ²¡æœ‰ `require('dotenv')`ï¼Ÿ

**A:** å› ä¸ºä½¿ç”¨ Docker Compose æ—¶ï¼Œç¯å¢ƒå˜é‡å·²ç»é€šè¿‡ `environment` å­—æ®µæ³¨å…¥åˆ°å®¹å™¨ä¸­ï¼ŒNode.js å¯ä»¥ç›´æ¥ä» `process.env` è¯»å–ï¼Œä¸éœ€è¦ dotenv åº“ã€‚

---

### Q2: å¦‚æœä¸ç”¨ Dockerï¼Œç›´æ¥è¿è¡Œä¼šæ€æ ·ï¼Ÿ

**A:** éœ€è¦åœ¨ä»£ç ä¸­æ·»åŠ ï¼š

```javascript
// backend/src/index.js é¡¶éƒ¨
require('dotenv').config({ path: '../../.env' });
```

æˆ–è€…åœ¨ backend ç›®å½•åˆ›å»ºè‡ªå·±çš„ `.env` æ–‡ä»¶ã€‚

---

### Q3: å‰ç«¯ä¸ºä»€ä¹ˆä¸€å®šè¦ `REACT_APP_` å‰ç¼€ï¼Ÿ

**A:** è¿™æ˜¯ Create React App çš„å®‰å…¨æœºåˆ¶ï¼š
- é˜²æ­¢æ•æ„Ÿçš„æœåŠ¡å™¨ç«¯å˜é‡ï¼ˆå¦‚æ•°æ®åº“å¯†ç ï¼‰è¢«æ‰“åŒ…åˆ°å‰ç«¯ä»£ç 
- åªæœ‰æ˜ç¡®æ ‡è®°ä¸ºå‰ç«¯ç”¨çš„å˜é‡æ‰ä¼šè¢«æš´éœ²

---

### Q4: ç”Ÿäº§ç¯å¢ƒæ€ä¹ˆåŠï¼Ÿ

**A:** æŸ¥çœ‹ `docker-compose.prod.yml`ï¼Œé€šå¸¸ä¼šï¼š
- ä½¿ç”¨ä¸åŒçš„ `.env.production` æ–‡ä»¶
- æˆ–é€šè¿‡ CI/CD ç³»ç»Ÿç›´æ¥æ³¨å…¥ç¯å¢ƒå˜é‡
- æˆ–ä½¿ç”¨ Kubernetes ConfigMap/Secret

---

## ä¸ƒã€æœ€ä½³å®è·µå»ºè®®

### âœ… æ¨èåšæ³•

1. **Monorepo + Docker é¡¹ç›®**ï¼š.env æ”¾æ ¹ç›®å½•
2. **ä½¿ç”¨ Docker Compose**ï¼šé€šè¿‡ `environment` å­—æ®µæ³¨å…¥
3. **å‰ç«¯å˜é‡**ï¼šå§‹ç»ˆä½¿ç”¨ `REACT_APP_` å‰ç¼€
4. **æ•æ„Ÿä¿¡æ¯**ï¼šä¸è¦æäº¤ .env åˆ° Gitï¼ˆä½¿ç”¨ .env.exampleï¼‰

### âš ï¸ æ³¨æ„äº‹é¡¹

1. **dotenv ä¸ä¼šå‘ä¸ŠæŸ¥æ‰¾**ï¼šéœ€è¦æ˜ç¡®æŒ‡å®šè·¯å¾„
2. **å‰ç«¯å˜é‡åœ¨æ„å»ºæ—¶ç¡®å®š**ï¼šä¸èƒ½è¿è¡Œæ—¶åŠ¨æ€ä¿®æ”¹
3. **ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§**ï¼šå®¹å™¨ç¯å¢ƒå˜é‡ > .env æ–‡ä»¶ > ä»£ç é»˜è®¤å€¼

---

## å…«ã€éªŒè¯æ–¹æ³•

### æ£€æŸ¥åç«¯ç¯å¢ƒå˜é‡

```bash
# è¿›å…¥ backend å®¹å™¨
docker exec -it fullstack_backend sh

# æŸ¥çœ‹ç¯å¢ƒå˜é‡
env | grep DB_
env | grep REDIS_
```

### æ£€æŸ¥å‰ç«¯æ„å»ºç»“æœ

```bash
# æ„å»ºå‰ç«¯
docker exec -it fullstack_frontend npm run build

# æŸ¥çœ‹æ‰“åŒ…åçš„ä»£ç ï¼ˆå˜é‡å·²è¢«æ›¿æ¢ï¼‰
docker exec -it fullstack_frontend cat build/static/js/main.*.js | grep localhost:5001
```

---

## æ€»ç»“

| å¯¹æ¯”é¡¹ | åç«¯ï¼ˆNode.jsï¼‰ | å‰ç«¯ï¼ˆReactï¼‰ |
|--------|----------------|---------------|
| **åŠ è½½å·¥å…·** | æ— éœ€ dotenv | react-scripts å†…ç½® |
| **å˜é‡æ¥æº** | Docker Compose æ³¨å…¥ | Docker Compose æ³¨å…¥ |
| **è¯»å–æ–¹å¼** | è¿è¡Œæ—¶ä» process.env è¯»å– | æ„å»ºæ—¶ Webpack æ›¿æ¢ |
| **å˜é‡å‰ç¼€** | æ— è¦æ±‚ | å¿…é¡» `REACT_APP_` |
| **å®‰å…¨æ€§** | å®¹å™¨å†…éƒ¨ä½¿ç”¨ | åªæš´éœ²ç‰¹å®šå‰ç¼€ |

**æ ¸å¿ƒç†è§£ï¼š**
- Docker Compose æ˜¯ç¯å¢ƒå˜é‡çš„**ç»Ÿä¸€åˆ†å‘ä¸­å¿ƒ**
- åç«¯åœ¨**è¿è¡Œæ—¶**è¯»å–ç¯å¢ƒå˜é‡
- å‰ç«¯åœ¨**æ„å»ºæ—¶**æ›¿æ¢ç¯å¢ƒå˜é‡
- Monorepo ç»“æ„ä¸‹ï¼Œæ ¹ç›®å½• .env é…åˆ Docker Compose æ˜¯æœ€ä¼˜æ–¹æ¡ˆ
