# 容器生命周期与常用命令

> 容器从创建到销毁，经历了哪些状态？如何用命令管理它们？

## 核心概念

容器是镜像的**运行实例**，就像进程是程序的运行实例一样：

```
镜像 (Image)    →    容器 (Container)
   静态模板              运行实例
   类比：程序              类比：进程
```

---

## 1. 容器生命周期状态图

```
                          docker create
                               │
                               ▼
┌──────────────────────────────────────────────────────────────────┐
│                         Created（已创建）                          │
│                         容器已创建但未运行                          │
└──────────────────────────────────────────────────────────────────┘
                               │
                        docker start
                               │
                               ▼
┌──────────────────────────────────────────────────────────────────┐
│                         Running（运行中）                          │
│                         容器正在运行                               │
│                               │                                   │
│              ┌────────────────┼────────────────┐                  │
│              │                │                │                  │
│       docker pause      docker stop     docker kill              │
│              │                │                │                  │
│              ▼                ▼                ▼                  │
│    ┌─────────────┐    ┌─────────────┐   (直接停止)                │
│    │   Paused    │    │   Exited    │                            │
│    │  （已暂停）  │    │  （已停止）  │                            │
│    └─────────────┘    └─────────────┘                            │
│              │                │                                   │
│       docker unpause    docker start                             │
│              │                │                                   │
│              └────────┬───────┘                                   │
│                       │                                           │
│                       ▼                                           │
│              Back to Running                                      │
└──────────────────────────────────────────────────────────────────┘
                               │
                          docker rm
                               │
                               ▼
                    ┌─────────────────┐
                    │    Removed      │
                    │   （已删除）     │
                    └─────────────────┘
```

### 状态说明

| 状态 | 说明 | 常见场景 |
|------|------|---------|
| **Created** | 容器已创建，但未启动 | `docker create` 后 |
| **Running** | 容器正在运行 | 正常工作状态 |
| **Paused** | 容器进程被冻结 | 临时暂停，不释放资源 |
| **Exited** | 容器已停止 | 正常退出或异常退出 |
| **Restarting** | 容器正在重启 | 配置了重启策略 |
| **Dead** | 容器异常状态 | 删除失败等异常 |

---

## 2. 基础生命周期命令

### 创建与启动

```bash
# 创建容器（不启动）
docker create --name myapp nginx:alpine

# 启动已创建的容器
docker start myapp

# 创建并启动（最常用）
docker run -d --name myapp nginx:alpine

# 创建并启动（前台交互模式）
docker run -it --name myapp node:alpine sh
```

### 停止与删除

```bash
# 优雅停止（发送 SIGTERM，等待 10 秒后 SIGKILL）
docker stop myapp

# 立即停止（发送 SIGKILL）
docker kill myapp

# 删除已停止的容器
docker rm myapp

# 强制删除运行中的容器
docker rm -f myapp

# 停止并删除（常用组合）
docker stop myapp && docker rm myapp
```

### 暂停与恢复

```bash
# 暂停容器（冻结进程，不释放内存）
docker pause myapp

# 恢复容器
docker unpause myapp
```

### 重启

```bash
# 重启容器
docker restart myapp

# 设置等待时间（秒）
docker restart -t 30 myapp
```

---

## 3. docker exec - 进入运行中的容器

这是最常用的调试命令！

### 基本用法

```bash
# 进入容器的交互式 shell
docker exec -it myapp sh

# 如果容器有 bash
docker exec -it myapp bash

# 执行单条命令
docker exec myapp ls -la /app

# 以 root 用户执行（容器内默认非 root 时）
docker exec -u root myapp cat /etc/passwd
```

### 参数说明

| 参数 | 说明 |
|------|------|
| `-i` | 保持 STDIN 打开（交互模式） |
| `-t` | 分配伪终端（TTY） |
| `-u` | 指定用户 |
| `-w` | 指定工作目录 |
| `-e` | 设置环境变量 |

### 项目实践

```bash
# 进入后端容器调试
docker exec -it docker-fullstack-practice-backend-1 sh

# 进入数据库容器
docker exec -it docker-fullstack-practice-postgres-1 psql -U postgres

# 进入 Redis 容器
docker exec -it docker-fullstack-practice-redis-1 redis-cli

# 查看 Nginx 配置
docker exec docker-fullstack-practice-nginx-1 cat /etc/nginx/nginx.conf
```

---

## 4. docker inspect - 查看详细信息

获取容器或镜像的完整配置信息（JSON 格式）。

### 基本用法

```bash
# 查看容器完整信息
docker inspect myapp

# 查看镜像完整信息
docker inspect nginx:alpine
```

### 使用 --format 提取特定字段

```bash
# 获取容器 IP 地址
docker inspect --format='{{.NetworkSettings.IPAddress}}' myapp

# 获取容器状态
docker inspect --format='{{.State.Status}}' myapp

# 获取挂载信息
docker inspect --format='{{json .Mounts}}' myapp

# 获取环境变量
docker inspect --format='{{json .Config.Env}}' myapp

# 获取端口映射
docker inspect --format='{{json .NetworkSettings.Ports}}' myapp
```

### 常用查询模板

```bash
# 查看容器启动命令
docker inspect --format='{{.Config.Cmd}}' myapp

# 查看容器工作目录
docker inspect --format='{{.Config.WorkingDir}}' myapp

# 查看容器健康状态
docker inspect --format='{{.State.Health.Status}}' myapp

# 查看容器重启次数
docker inspect --format='{{.RestartCount}}' myapp
```

---

## 5. docker cp - 容器与宿主机文件互传

### 从容器复制到宿主机

```bash
# 复制单个文件
docker cp myapp:/app/config.json ./config.json

# 复制整个目录
docker cp myapp:/app/logs ./local-logs

# 复制到当前目录
docker cp myapp:/app/package.json .
```

### 从宿主机复制到容器

```bash
# 复制文件到容器
docker cp ./fix.patch myapp:/app/

# 复制目录到容器
docker cp ./config/ myapp:/app/config/
```

### 使用场景

| 场景 | 命令示例 |
|------|---------|
| 导出日志分析 | `docker cp myapp:/var/log/app.log .` |
| 导出数据库备份 | `docker cp postgres:/backup.sql .` |
| 临时修复文件 | `docker cp hotfix.js myapp:/app/` |
| 提取配置模板 | `docker cp nginx:/etc/nginx/nginx.conf .` |

---

## 6. docker diff - 查看文件系统变化

查看容器运行后，相对于镜像的文件变化。

```bash
docker diff myapp

# 输出示例：
A /app/logs/error.log       # A = Added（新增）
C /app/config               # C = Changed（修改）
D /app/temp/cache.tmp       # D = Deleted（删除）
```

### 状态标记

| 标记 | 含义 |
|------|------|
| `A` | Added - 新增的文件或目录 |
| `C` | Changed - 修改的文件或目录 |
| `D` | Deleted - 删除的文件或目录 |

### 使用场景

- 调试时检查容器写入了哪些文件
- 确认日志文件位置
- 检查临时文件是否被清理

---

## 7. docker logs - 日志查看技巧

### 基本用法

```bash
# 查看全部日志
docker logs myapp

# 实时跟踪日志（类似 tail -f）
docker logs -f myapp

# 查看最后 100 行
docker logs --tail 100 myapp

# 显示时间戳
docker logs -t myapp

# 查看指定时间后的日志
docker logs --since 2024-01-01T10:00:00 myapp
docker logs --since 30m myapp  # 最近 30 分钟

# 组合使用
docker logs -f --tail 50 -t myapp
```

### Docker Compose 日志

```bash
# 查看所有服务日志
docker-compose logs

# 查看特定服务日志
docker-compose logs backend

# 实时跟踪所有服务
docker-compose logs -f

# 最后 50 行，带时间戳
docker-compose logs --tail 50 -t

# 多个服务
docker-compose logs backend frontend
```

### 参数速查

| 参数 | 说明 |
|------|------|
| `-f, --follow` | 实时跟踪 |
| `--tail N` | 最后 N 行 |
| `-t, --timestamps` | 显示时间戳 |
| `--since` | 指定时间之后 |
| `--until` | 指定时间之前 |

---

## 8. docker stats - 资源监控

实时查看容器资源使用情况。

```bash
# 查看所有运行容器的资源使用
docker stats

# 查看特定容器
docker stats myapp

# 只显示一次（不实时更新）
docker stats --no-stream

# 自定义输出格式
docker stats --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"
```

### 输出字段说明

```
CONTAINER ID   NAME      CPU %   MEM USAGE / LIMIT     MEM %   NET I/O          BLOCK I/O
a1b2c3d4e5f6   backend   0.50%   128MiB / 512MiB       25.00%  1.2MB / 500KB    10MB / 5MB
```

| 字段 | 说明 |
|------|------|
| CPU % | CPU 使用百分比 |
| MEM USAGE / LIMIT | 内存使用量 / 限制 |
| MEM % | 内存使用百分比 |
| NET I/O | 网络 I/O（入/出） |
| BLOCK I/O | 磁盘 I/O（读/写） |

---

## 9. 容器状态查看命令

### docker ps - 列出容器

```bash
# 查看运行中的容器
docker ps

# 查看所有容器（包括已停止）
docker ps -a

# 只显示容器 ID
docker ps -q

# 查看最近创建的容器
docker ps -l

# 按条件过滤
docker ps --filter status=running
docker ps --filter name=backend

# 自定义输出格式
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
```

### 输出字段说明

```
CONTAINER ID   IMAGE          COMMAND       CREATED        STATUS         PORTS                  NAMES
a1b2c3d4e5f6   node:alpine   "node app"    5 minutes ago  Up 5 minutes   0.0.0.0:3000->3000/tcp backend
```

| 字段 | 说明 |
|------|------|
| CONTAINER ID | 容器唯一标识（短格式） |
| IMAGE | 使用的镜像 |
| COMMAND | 启动命令 |
| CREATED | 创建时间 |
| STATUS | 当前状态 |
| PORTS | 端口映射 |
| NAMES | 容器名称 |

---

## 10. 命令速查表

### 生命周期管理

| 命令 | 用途 |
|------|------|
| `docker create` | 创建容器 |
| `docker start` | 启动容器 |
| `docker run` | 创建并启动 |
| `docker stop` | 优雅停止 |
| `docker kill` | 强制停止 |
| `docker restart` | 重启 |
| `docker pause` | 暂停 |
| `docker unpause` | 恢复 |
| `docker rm` | 删除容器 |

### 调试诊断

| 命令 | 用途 |
|------|------|
| `docker exec` | 进入容器执行命令 |
| `docker logs` | 查看日志 |
| `docker inspect` | 查看详细配置 |
| `docker diff` | 查看文件变化 |
| `docker stats` | 资源监控 |
| `docker top` | 查看容器进程 |

### 文件操作

| 命令 | 用途 |
|------|------|
| `docker cp` | 文件互传 |
| `docker export` | 导出容器为 tar |
| `docker import` | 从 tar 导入镜像 |

---

## 11. 项目实践：调试当前项目

```bash
# 1. 查看所有服务状态
docker-compose ps

# 2. 查看后端日志
docker-compose logs -f backend

# 3. 进入后端容器调试
docker exec -it docker-fullstack-practice-backend-1 sh

# 4. 查看容器资源使用
docker stats

# 5. 检查数据库连接
docker exec -it docker-fullstack-practice-postgres-1 \
  psql -U postgres -c "SELECT 1"

# 6. 导出数据库备份
docker exec docker-fullstack-practice-postgres-1 \
  pg_dump -U postgres myapp > backup.sql

# 7. 查看 Nginx 配置
docker exec docker-fullstack-practice-nginx-1 \
  cat /etc/nginx/conf.d/default.conf
```

---

## 下一步

掌握了容器管理命令后，建议继续阅读：
- [Docker镜像管理基础.md](./Docker镜像管理基础.md) - 学习镜像的管理和清理
