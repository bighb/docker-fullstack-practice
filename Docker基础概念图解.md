# Docker 基础概念图解

> 本文档以图解为主，帮助理解 Docker 核心概念。

---

## 一、Docker 核心三要素

```
┌─────────────────┐
│   Dockerfile    │ ← 打包说明书（菜谱）
│   （文本文件）   │
└────────┬────────┘
         │
         │ docker build（打包）
         ↓
┌─────────────────┐
│  镜像 (Image)   │ ← 打包好的产物（预制菜罐头）
│   （只读模板）   │    代码 + 环境 + 依赖 = 完整的包
└────────┬────────┘
         │
         │ docker run（运行）
         ↓
┌─────────────────┐
│ 容器 (Container)│ ← 运行中的实例（盘子里的菜）
│  （隔离的进程）  │    一个镜像可启动多个容器
└─────────────────┘
```

### 概念对比

| 概念       | 本质     | 特点             | 类比       |
| ---------- | -------- | ---------------- | ---------- |
| Dockerfile | 文本文件 | 描述如何构建镜像 | 菜谱       |
| 镜像       | 只读模板 | 可分享、可存储   | 预制菜罐头 |
| 容器       | 运行实例 | 隔离、可启停     | 上桌的菜   |

---

## 二、为什么需要自定义 Dockerfile

### 官方镜像 vs 自定义镜像

```
┌────────────────────────────────────────────────────────┐
│                    官方镜像                             │
│                                                        │
│   PostgreSQL、Redis、Nginx 等                          │
│   ↓                                                    │
│   已经是完整的软件，直接配置参数即可使用                   │
│   ↓                                                    │
│   不需要 Dockerfile                                    │
└────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────┐
│                   自定义镜像                            │
│                                                        │
│   你写的 Frontend / Backend 代码                        │
│   ↓                                                    │
│   官方 Node 镜像只有运行环境，没有你的业务代码             │
│   ↓                                                    │
│   需要 Dockerfile 把你的代码打包进去                     │
└────────────────────────────────────────────────────────┘
```

### 形象理解

```
PostgreSQL 官方镜像：
┌─────────────────────┐
│  完整的数据库软件    │  ← 开盒即用
│  只需告诉它配置      │
└─────────────────────┘

Node 官方镜像：
┌─────────────────────┐
│  只有 Node.js 环境  │  ← 空的运行环境
│  里面没有你的代码    │
└─────────────────────┘
         +
┌─────────────────────┐
│  你的业务代码        │  ← 通过 Dockerfile 打包进去
│  package.json       │
│  src/...            │
└─────────────────────┘
         ↓
┌─────────────────────┐
│  自定义镜像         │  ← 环境 + 代码 = 可运行
└─────────────────────┘
```

---

## 三、多阶段构建

### 为什么要分阶段？

开发和生产的需求不同：

```
开发环境                          生产环境
┌──────────────────┐            ┌──────────────────┐
│ ✓ 需要热更新      │            │ ✗ 不需要热更新    │
│ ✓ 需要源码        │            │ ✗ 不需要源码      │
│ ✓ 需要调试工具    │            │ ✗ 不需要调试工具   │
│ ✗ 不在意镜像大小  │            │ ✓ 镜像越小越好    │
└──────────────────┘            └──────────────────┘
```

### 三阶段流程图

```
┌─────────────────────────────────────────────────────────────┐
│                     Dockerfile 多阶段构建                    │
└─────────────────────────────────────────────────────────────┘

    ┌───────────────┐
    │  development  │ ← 阶段1：开发环境
    │───────────────│
    │ 完整源码       │
    │ 所有依赖       │
    │ 热更新支持     │
    │ ~500MB        │
    └───────┬───────┘
            │
            ↓
    ┌───────────────┐
    │    builder    │ ← 阶段2：构建阶段
    │───────────────│
    │ 执行 npm build │
    │ 生成静态文件   │
    │ (中间产物)     │
    └───────┬───────┘
            │
            │ COPY --from=builder（只拿构建产物）
            ↓
    ┌───────────────┐
    │  production   │ ← 阶段3：生产环境
    │───────────────│
    │ 只有静态文件   │
    │ Nginx 托管    │
    │ ~25MB         │
    └───────────────┘
```

### 如何控制运行哪个阶段？

```
docker build 命令：

┌────────────────────────────────────┐
│ docker build --target development │ ──→ 停在阶段1，得到开发镜像
├────────────────────────────────────┤
│ docker build --target production  │ ──→ 跑完全部，得到生产镜像
├────────────────────────────────────┤
│ docker build                      │ ──→ 默认跑到最后一个阶段
└────────────────────────────────────┘

docker-compose.yml 中指定：

┌────────────────────────┐
│ build:                 │
│   context: ./frontend  │
│   target: development  │ ← 指定使用哪个阶段
└────────────────────────┘
```

---

## 四、本项目架构总览

### 5 个服务的关系

```
                        ┌──────────────┐
                        │    Nginx     │
                        │    :80       │ ← 统一入口（反向代理）
                        └──────┬───────┘
                               │
              ┌────────────────┼────────────────┐
              │                                 │
              ↓                                 ↓
      ┌──────────────┐                 ┌──────────────┐
      │   Frontend   │                 │   Backend    │
      │    :3000     │                 │    :5001     │
      │  (React)     │                 │  (Node.js)   │
      └──────────────┘                 └──────┬───────┘
                                              │
                              ┌───────────────┼───────────────┐
                              │                               │
                              ↓                               ↓
                      ┌──────────────┐               ┌──────────────┐
                      │  PostgreSQL  │               │    Redis     │
                      │    :5432     │               │    :6379     │
                      │   (数据库)   │               │   (缓存)     │
                      └──────────────┘               └──────────────┘
```

### 服务来源对比

```
┌─────────────┬─────────────────┬─────────────────────┐
│    服务     │      来源       │        说明          │
├─────────────┼─────────────────┼─────────────────────┤
│  Frontend   │ 自定义Dockerfile │ 你写的 React 代码    │
│  Backend    │ 自定义Dockerfile │ 你写的 Node.js 代码  │
│  Nginx      │ 官方镜像+配置    │ 反向代理            │
│  PostgreSQL │ 官方镜像        │ 主数据库            │
│  Redis      │ 官方镜像        │ 缓存层              │
└─────────────┴─────────────────┴─────────────────────┘
```

### 启动顺序

```
docker-compose up 执行顺序：

第1步    第2步      第3步       第4步
  │        │          │           │
  ↓        ↓          ↓           ↓
┌────┐  ┌────┐    ┌────────┐  ┌───────┐
│ PG │  │Redis│ →  │Backend │ → │Nginx │
└────┘  └────┘    └────────┘  └───────┘
   ↑       ↑          ↑
   │       │          │
   └───────┴──────────┘
   Backend 等待数据库就绪后才启动
```

---

## 五、Docker 解决的核心问题

```
传统部署：
┌──────────────┐                    ┌──────────────┐
│   开发者A    │ ────  代码  ────→  │   开发者B    │
│   电脑       │                    │   电脑       │
└──────────────┘                    └──────────────┘
                                           │
                                    "环境不一致"
                                    "依赖版本不对"
                                    "配置有差异"
                                           │
                                           ↓
                                       跑不起来 😭

Docker 部署：
┌──────────────┐                    ┌──────────────┐
│   开发者A    │ ────  镜像  ────→  │   开发者B    │
│   电脑       │                    │   电脑       │
└──────────────┘                    └──────────────┘
                                           │
                                 代码 + 环境 + 依赖 + 配置
                                       全部打包在一起
                                           │
                                           ↓
                                       一定能跑 ✅
```

---

## 六、常用命令速查

```
镜像相关：
┌────────────────────────────┬─────────────────────┐
│ docker build -t 名称 .     │ 构建镜像            │
│ docker images              │ 查看所有镜像        │
│ docker rmi 镜像名          │ 删除镜像            │
└────────────────────────────┴─────────────────────┘

容器相关：
┌────────────────────────────┬─────────────────────┐
│ docker run 镜像名          │ 启动容器            │
│ docker ps                  │ 查看运行中的容器     │
│ docker stop 容器ID         │ 停止容器            │
│ docker rm 容器ID           │ 删除容器            │
└────────────────────────────┴─────────────────────┘

编排相关（docker-compose）：
┌────────────────────────────┬─────────────────────┐
│ docker-compose up -d       │ 启动所有服务        │
│ docker-compose down        │ 停止所有服务        │
│ docker-compose logs        │ 查看日志            │
│ docker-compose ps          │ 查看服务状态        │
└────────────────────────────┴─────────────────────┘
```

---

## 总结

**Docker 核心思想**：把代码和运行环境打包成独立镜像，用镜像启动隔离的容器服务。

```
一句话理解：
┌─────────────────────────────────────────────────┐
│  Dockerfile = 说明书                            │
│  镜像 = 打包好的软件                            │
│  容器 = 运行中的软件                            │
│  docker-compose = 同时管理多个容器              │
└─────────────────────────────────────────────────┘
```
